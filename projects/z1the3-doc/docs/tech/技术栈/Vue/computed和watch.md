# computed å’Œ watch

ä»Žè¿™ä¸ªå‡½æ•°å, å°±å¯ä»¥çœ‹æ˜Žç™½ initComputed, è¿™æ˜¯åˆå§‹åŒ–è®¡ç®—å±žæ€§çš„å‡½æ•°. å®ƒçš„å°±æ˜¯éåŽ†ä¸‹æˆ‘ä»¬å®šä¹‰çš„ computed å¯¹è±¡, ç„¶åŽä»Žä¸­ç»™æ¯ä¸€ä¸ªå€¼å®šä¹‰ä¸€ä¸ª watcher å®žä¾‹.

è®¡ç®—å±žæ€§æ‰§è¡Œçš„æ—¶å€™ä¼šè®¿é—®åˆ°, this.a å’Œ this.b. è¿™æ—¶å€™è¿™ä¸¤ä¸ªå€¼å› ä¸º Data åˆå§‹åŒ–çš„æ—¶å€™å°±è¢«å®šä¹‰æˆå“åº”å¼æ•°æ®äº†. å®ƒä»¬å†…éƒ¨ä¼šæœ‰ä¸€ä¸ª Dep å®žä¾‹, Dep å®žä¾‹å°±ä¼šæŠŠè¿™ä¸ªè®¡ç®— computed watcher æ”¾åˆ°è‡ªå·±çš„ sub æ•°ç»„é‡Œ. å¾…æ—¥åŽè‡ªå·±æ›´æ–°äº†, å°±åŽ»é€šçŸ¥æ•°ç»„å†…çš„ watcher å®žä¾‹æ›´æ–°.

```js
const computedWatcherOptions = { lazy: true };

// vm: ç»„ä»¶å®žä¾‹ computed ç»„ä»¶å†…çš„ è®¡ç®—å±žæ€§å¯¹è±¡
function initComputed(vm: Component, computed: Object) {
  // éåŽ†æ‰€æœ‰çš„è®¡ç®—å±žæ€§
  for (const key in computed) {
    // ç”¨æˆ·å®šä¹‰çš„ computed
    const userDef = computed[key];
    const getter = typeof userDef === "function" ? userDef : userDef.get;

    watchers[key] = new Watcher( // ðŸ‘ˆ è¿™é‡Œ
      vm,
      getter || noop,
      noop,
      computedWatcherOptions
    );

    defineComputed(vm, key, userDef); //å¯¹è®¡ç®—å±žæ€§æœ¬èº«åšå“åº”å¼å¤„ç†
  }
}
```

### dirty çš„ä½œç”¨

ä»–å°±æ˜¯ç”¨æ¥è®°å½•æˆ‘ä»¬ä¾èµ–çš„å€¼æœ‰æ²¡æœ‰å˜, å¦‚æžœå˜äº†å°±é‡æ–°è®¡ç®—ä¸€ä¸‹å€¼, å¦‚æžœæ²¡å˜, é‚£å°±**è¿”å›žä»¥å‰çš„å€¼**. å°±åƒä¸€ä¸ªæ‡’åŠ è½½çš„ç†å¿µ. è¿™ä¹Ÿæ˜¯è®¡ç®—å±žæ€§ç¼“å­˜çš„ä¸€ç§æ–¹å¼

å¦‚æžœåŒ…å«å¤æ‚æ€§çš„è®¡ç®—ï¼Œåˆ™è¿™ä¸€æ­¥æœ‰æœºä¼šå›žé¿æŽ‰

ä¸€å¼€å§‹ dirty ä¸º true, ä¸€æ—¦æ‰§è¡Œäº†ä¸€æ¬¡è®¡ç®—,å°±ä¼šè®¾ç½®ä¸º false. ç„¶åŽå½“å®ƒå®šä¹‰çš„å‡½æ•°å†…éƒ¨ä¾èµ–çš„å€¼æ¯”å¦‚: this.a å’Œ this.b å‘å£°äº†å˜åŒ–. è¿™ä¸ªå€¼å°±ä¼šé‡æ–°å˜ä¸º true;

å³
ä¸‹ä¸€æ¬¡æ‰§è¡Œè®¡ç®—å±žæ€§æ—¶,å°±ä¼šåŽ»é‡æ–°è®¡ç®—,(åªåœ¨è°ƒç”¨æ—¶å†³å®šæ˜¯å¦é‡æ–°è®¡ç®—ï¼Œæ˜¯åŒæ­¥çš„ï¼›è€Œä¸æ˜¯åœ¨ä¾èµ–å‘ç”Ÿå˜åŒ–åŽï¼Œç«‹å³å˜åŠ¨)

#### Computed å±žæ€§,watch å’Œç»„ä»¶ä¸€æ ·, æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€ä¸ª watcher å®žä¾‹

ç›‘å¬å±žæ€§ watch æ˜¯å¼‚æ­¥è§¦å‘çš„, ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢?

#### å®žé™…ä¸Š watch çš„æ‰§è¡Œé€»è¾‘å’Œç»„ä»¶çš„æ¸²æŸ“æ˜¯ä¸€æ ·çš„. å®ƒä»¬éƒ½ä¼šè¢«æ”¾åˆ°ä¸€ä¸ª nextTick å‡½æ•°ä¸­, æ²¡é”™å°±æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„ API.å®ƒå¯ä»¥è®©æˆ‘ä»¬çš„åŒæ­¥é€»è¾‘, æ”¾åˆ°ä¸‹ä¸€ä¸ª Tick åœ¨æ‰§è¡Œ

#### computed å’Œ watch å¯¹äºŽæ–°å€¼ä¸Žæ—§å€¼ä¸€æ ·çš„èµ‹å€¼æ“ä½œ, éƒ½ä¸ä¼šåšä»»ä½•å˜åŒ–. ä½†è¿™ç‚¹çš„å®žçŽ°æ˜¯ç”±å“åº”å¼ç³»ç»Ÿå®Œæˆçš„

è®¡ç®—å±žæ€§å…·æœ‰"æ‡’è®¡ç®—"åŠŸèƒ½, åªæœ‰ä¾èµ–çš„å€¼å˜åŒ–äº†, æ‰å…è®¸é‡æ–°è®¡ç®—. ç§°ä¸º"ç¼“å­˜", ä¸ªäººè§‰å¾—ä¸å‡†ç¡®

#### åœ¨æ•°æ®æ›´æ–°æ—¶, computed çš„ dirty çŠ¶æ€ä¼šç«‹å³æ”¹å˜, è€Œ watch ä¸Žç»„ä»¶é‡æ–°æ¸²æŸ“, è‡³å°‘éƒ½ä¼šåœ¨ä¸‹ä¸€ä¸ª"tick"æ‰§è¡Œ

å› æ­¤ watch å¯ä»¥å¼‚æ­¥è§¦å‘

computed ä¸å¯ä»¥

## ä½¿ç”¨

### computed

æŽ¥å—ä¸€ä¸ª getter å‡½æ•°ï¼Œè¿”å›žä¸€ä¸ªåªè¯»çš„å“åº”å¼ ref å¯¹è±¡ã€‚è¯¥ ref é€šè¿‡ .value æš´éœ² getter å‡½æ•°çš„è¿”å›žå€¼ã€‚å®ƒä¹Ÿå¯ä»¥æŽ¥å—ä¸€ä¸ªå¸¦æœ‰ get å’Œ set å‡½æ•°çš„å¯¹è±¡æ¥åˆ›å»ºä¸€ä¸ªå¯å†™çš„ ref å¯¹è±¡ã€‚

```js
const plusOne = computed(() => count.value + 1);

const plusOne = computed({
  get: () => count.value + 1,
  set: (val) => {
    count.value = val - 1;
  },
});
```

### watch

ä¾¦å¬ä¸€ä¸ª getter å‡½æ•°ï¼š

```js
const state = reactive({ count: 0 });
watch(
  () => state.count,
  (count, prevCount) => {
    /* ... */
  }
);
```

ä¾¦å¬å¤šä¸ªæ¥æºï¼Œè‡ªåŠ¨å˜ä¸ºæ•°ç»„

```js
watch([fooRef, barRef], ([foo, bar], [prevFoo, prevBar]) => {
  /* ... */
});
```
